<HTML>
<HEAD>
  <TITLE>Combining SRTM height, water body and ETOPO bathymetry data</TITLE>
  <META http-equiv=Content-Type content="text/html; charset=windows-1252">
  <META http-equiv=Pragma content=no-cache>
  <META http-equiv=Content-Language content=en-uk>
  <link rel="stylesheet" href="css/equipment.css">
</HEAD>

<BODY>

<TABLE>
	<TR class="white">
		<TD WIDTH=100px ALIGN=CENTER VALIGN=MIDDLE>
		</TD>
		<TD VALIGN=MIDDLE>
			<H1>Combining SRTM height, water body and ETOPO bathymetry data</H1>
		</TD>
	</TR>
</TABLE>

<DIR>Data source</DIR>

<p>
We have the three different sources of data :
<ul>
	<li><a href="https://www.ngdc.noaa.gov/mgg/global/global.html">ETOPO bathymetry</a> : seabed depths data with approximate resolution 1 x 1 km</li>
	<li><a href="https://dds.cr.usgs.gov/srtm/version2_1/SRTM3/">SRTM Digital Elevation</a> : HGT files with resolution approximately 100 x 100 metres</li>
	<li><a href="https://dds.cr.usgs.gov/srtm/version2_1/SWBD/">SWBD water body data</a> - shore contours with high resolution in ESRI format</li>
</ul>
</p>

<p>
An SRTM HGT height file covers 1 x 1° area with height values represented as regular grid of 1200x1200 intervals (1201x1201 points). Such file does not contain data about sea depth, as it was generated by the Shuttle radar measuring heights from land or sea surface.
To be able to distinguish between land or water space, SWBD data is available - shore contours.
</p>

<p>
Before processing, SRTM and SWBD data are corrected :
	<ul>
		<li>SRTM data with "undefined" values are replaced by averaged values from point neighbours</li>
		<li>ESRI "PolygonZ" waterbody data formats are corrected in few cases</li>
		<li>ESRI polygon rings orientation is corrected (first polygon ring must always have positive area which is not always the case, e.g. like in e100n05e.zip)</li>
	</ul>
</p>

<p>
Our purpose is to <B>combine all the data into a regular HGT file grid.</B>.
</p>

<DIR>Solution</DIR>

<IMG SRC="DataSources.png">

<p>
Incorporation of depth is straightforward : once we get shore contours, we simply replace HGT height values by depth values everywhere inside water areas. 
At points where low-resolution ETOPO data is grossly inaccurate (e.g. provides positive land height where it should be negative), a <B>default</B> water depth is taken.
</p>

<p>
Original height data may substantially differ from much more accurate shore contours. Now we need to bring HGT data close to shore contour data.
</p>

<p>
Suppose we have a regular grid of 1200x1200 intervals (1201x1201 points) for geographic area of size 1 by 1°. At each point we have a height value. So, a cell resolution for this file is, roughly speaking, 100 by 100 metres.
</p>

<p>
Let use represent height function by piecewise linear hat basis in the form
</p>

<p>
H(u,v) = &Sigma;<sub>i,j=0,1200</sub>P<sub>i,j</sub> R<sub>i,j</sub>(u,v)
</p>

where 
<ul>
	<li>u,v are parameters along x,y</li>
	<li>H - height (depth) value</li>
	<li>P - control points</li>
	<li>R - piecewise linear basis
</ul>

<p>
Suppose we have a number of constraint points (they are water countour points) which should be moved to level H = 0.
Call them S<sub>f</sub>, f=1,...,h; they have parameter values (u<sub>f</sub>,v<sub>f</sub>), f=1,...h. These points will be moved to target points T<sub>f</sub>, f=1,...,h with zero height.
</p>

<p>
In order to move S<sub>f</sub> to T<sub>f</sub>, f=1,...,h, we need to compute displacement &delta;<sub>i,j</sub> of each control point P<sub>i,j</sub> so that the following constraints are satisfied :
</p>

<p>
T<sub>f</sub> = &Sigma;<sub>i,j=0,1200</sub>(P<sub>i,j</sub> + &delta;<sub>i,j</sub>) R<sub>i,j</sub>(u<sub>f</sub>,v<sub>f</sub>) = S<sub>f</sub> + &Sigma;<sub>i,j=0,1200</sub>&delta;<sub>i,j</sub> R<sub>i,j</sub>(u<sub>f</sub>,v<sub>f</sub>)
</p>
<p>
f = 1,...,h
</p>
<p>
Let us minimize displacements with constraints introduced with Lagrange multipliers
</p>
L = &Sigma;<sub>i,j=0,1200</sub>|&delta;<sub>i,j</sub>|<sup>2</sup> + &Sigma;<sub>f=1..h</sub>&lambda;<sub>f</sub>(T<sub>f</sub> - S<sub>f</sub> - &Sigma;<sub>i,j=0,1200</sub>&delta;<sub>i,j</sub> R<sub>i,j</sub>(u<sub>f</sub>,v<sub>f</sub>))
<p>
where &lambda;<sub>f</sub>, f = 1,...,h are Lagrange multipliers. After differentiating this function by displacements &delta; and Lagrange multipliers &lambda; and equating to zero we get a system of two equations
</p>
<p>
T<sub>f</sub> = S<sub>f</sub> + &Sigma;<sub>i,j=0,1200</sub>&delta;<sub>i,j</sub> R<sub>i,j</sub>(u<sub>f</sub>,v<sub>f</sub>)&nbsp;&nbsp;f = 1,...,h
</p>
<p>
&delta;<sub>i,j</sub> = 0.5 &Sigma;<sub>f=1,h</sub> &lambda;<sub>f</sub> R<sub>i,j</sub>(u<sub>f</sub>,v<sub>f</sub>)&nbsp;&nbsp;0&le;i&le;1200, 0&le;j&le;1200.
</p>
<p>
In the matrix form
</p>
<p>
<B>D</B>=<B>R</B><sup>T</sup><B>&delta;</B>&nbsp;&nbsp;&nbsp;&nbsp;(1)<br />
<B>&delta;</B>=<B>R</B><B>&lambda;</B>&nbsp;&nbsp;&nbsp;&nbsp;(2)
</p>
<p>
By substituting equation (2) into equation (1)
</p>
<p>
<B>D</B>=<B>R</B><sup>T</sup><B>R</B><B>&lambda;</B>
</p>
<p>
from where we can get Lagrange multipliers by solving a system of linear equations. Further, we get the required grid node displacements from equation (2).
</p>
<p>
Nodes of HGT file grid are displaced by these values to make cell intersections with plane Z = 0 close to specified shore countour lines.
</p>

<DIR>References</DIR>

<p>
1. Direct manipulation of FFD : efficient explicit solutions and decomposible multiple point constraints. Shi-Min Hu, Hui Zhang, Chiew-Lan Tai, Jia-Guang Sun. Springer-Verlag 2001.
</p>

<TABLE>  
	<tr>
		<td colspan="3">
			<div class="footer">
				Copyright 2017 Andrey Kudryavtsev
			</div>
		</td>
	</tr>

</TABLE>

</BODY>
</HTML>